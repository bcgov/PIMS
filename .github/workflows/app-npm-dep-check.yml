name: NPM Dependency Reports

on:
  schedule:
    - cron: '0 15 * * 2' # Tuesday morning at 7:00-8:00am Pacific Time.
  pull_request:
      branches:
          - 'main'
      paths:
          - '.github/workflows/create-jira-tickets.yml'
      types: [synchronize]
  workflow_dispatch:

# START HERE! v

# ADD REQUIRED FILES:
# - .github/helpers/parse-json5-config.js
# - .github/helpers/npm-deps/parse-npm-deps.cjs
# - .github/helpers/npm-deps/create-report.cjs
# - .github/helpers/npm-deps/create-report-issues.cjs
# - .github/helpers/github-api/github-api-requests.cjs
# - .github/helpers/github-api/create-and-close-existing-issue.cjs
# - .github/config/dep-report.json5

# EDIT .github/config/dep-report.json5
# DO NOT Edit below env variables.
env:
  GITHUB_REPOSITORY: ${{ github.repository }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # Parse Vars from config.
  parse-json5-config:
      runs-on: ubuntu-22.04
      outputs:
        # save output from dep-report.json5 to Github env variables
        packageJsonPaths: ${{ steps.parse_config.outputs.packageJsonPaths }}
        ignoreList: ${{ steps.parse_config.outputs.ignoreList }}
        depLevels: ${{ steps.parse_config.outputs.depLevels }}

      steps:
        # Checkout branch.
        - name: Checkout Repository
          uses: actions/checkout@v4

        # Install json5 npm package for parsing config.
        - name: Install Dependencies
          run: npm install json5 os

        # Run script to convert json5 config to Output Vars.
        - name: Run Script
          id: parse_config
          run: node .github/helpers/parse-json5-config .github/config/dep-report.json5

  # Check package versions for updates.
  parse-package-versions:
    runs-on: ubuntu-22.04
    needs: parse-json5-config
    env:
      packageJsonPaths: ${{ needs.parse-json5-config.outputs.packageJsonPaths }}
    container:
      # Lightweight NodeJS Image
      image: node:21.5-bullseye-slim

    steps:
      # Checkout branch.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Run NodeJS script to check for latest npm dependency versions and capture output.
      - name: Run NPM DEP Check Node.js script
        id: check_versions
        run: |
          node .github/helpers/npm-deps/parse-npm-deps.cjs > outdatedDeps.json

      # Upload the output as an artifact.
      - name: Upload output
        uses: actions/upload-artifact@v4
        with:
          name: outdatedDeps
          path: outdatedDeps.json

  # Create comment text
  create-comment-text:
    runs-on: ubuntu-22.04
    needs:
      - parse-json5-config
      - parse-package-versions
    env:
      ignoreList: ${{ needs.parse-json5-config.outputs.ignoreList }}
      depLevels: ${{ needs.parse-json5-config.outputs.depLevels }}
    outputs:
        commentContents: ${{ steps.create_comment.outputs.commentContents }}
    steps:
      # download artifact from parse-package-versions
      - name: Download output
        uses: actions/download-artifact@v4
        with:
          name: outdatedDeps
          path: .

      # encode file to github needs
      - name: Encode Outdated Deps
        shell: bash
        run: |
          OUTPUT=$(cat outdatedDeps.json)
          OUTPUT="${OUTPUT//'%'/'%25'}"
          OUTPUT="${OUTPUT//$'\n'/'%0A'}"
          OUTPUT="${OUTPUT//$'\r'/'%0D'}"
          echo "DEP_INPUT=${OUTPUT}" >> $GITHUB_ENV

      # checkout repo and branch
      - name: Checkout Branch
        uses: actions/checkout@v4

      # setup Python environment
      - name: setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # current Python version

      # Run Python Script to Create Comment
      - name: Create Comment Contents
        id: create_comment
        env:
          DEP_INPUT: ${{ env.DEP_INPUT }} # dependency updates
        run: |
          python3 .github/helpers/npm-deps/parse_to_comment.py

  # Write the output text for the GitHub Issue.
  write-output:
    needs:
      - parse-json5-config
      - parse-package-versions
    runs-on: ubuntu-22.04
    env:
      packageJsonPaths: ${{ needs.parse-json5-config.outputs.packageJsonPaths }}
    container:
      # Lightweight NodeJS Image
      image: node:21.5-bullseye-slim

    steps:
      # Checkout branch.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Download the output artifact from parse-package-versions.
      - name: Download output
        uses: actions/download-artifact@v4
        with:
          name: outdatedDeps
          path: .

      # Run NodeJS script to create GitHub Issue body.
      - name: Run NPM DEP Check Node.js script
        id: check_versions
        run: |
          node .github/helpers/npm-deps/create-report.cjs > outputText.json

      # Upload the output as an artifact.
      - name: Upload output
        uses: actions/upload-artifact@v4
        with:
          name: outputText
          path: outputText.json

  # Create the GitHub Issues.
  create-issues:
    needs:
      - parse-json5-config
      - create-comment-text
      - write-output
    runs-on: ubuntu-22.04
    env:
      packageJsonPaths: ${{ needs.parse-json5-config.outputs.packageJsonPaths }}
      commentContents: ${{ needs.create-comment-text.outputs.commentContents }}
    container:
      # Lightweight NodeJS Image
      image: node:21.5-bullseye-slim

    steps:
      # Checkout branch.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Download the output artifact.
      - name: Download output
        uses: actions/download-artifact@v4
        with:
          name: outputText
          path: .

      # Install @octokit/rest npm package for making GitHub rest API requests.
      - name: Install @octokit/rest npm
        run: npm i @octokit/rest

      # Run Node Script to Create GitHub Issue.
      - name: Create GitHub Issues
        run: |
          node .github/helpers/npm-deps/create-report-issues.cjs

      # Install jq for JSON processing
      - name: Install jq
        run: |
         apt-get update
         apt-get install -y jq curl

      # Send issue content to JIRA webhook using curl
      - name: Create JIRA Tickets
        run: |
            # Extract the content from the commentContents JSON
            COMMENT_JSON='${{ env.commentContents }}'
            
            # Extract API and APP content using jq
            API_CONTENT=$(echo $COMMENT_JSON | jq -r '.["express-api"]')
            APP_CONTENT=$(echo $COMMENT_JSON | jq -r '.["react-app"]')
            
            # Create JIRA ticket for API issues
            if [ -n "$API_CONTENT" ] && [ "$API_CONTENT" != "null" ]; then
              echo "Sending API dependency report to Jira..."
              
              # Debug: check the content
              echo "Content length: ${#API_CONTENT}"
              echo "First few characters:"
              echo "$API_CONTENT" | head -c 100
              
              # Write content to file and properly escape it for JSON
              echo "$API_CONTENT" > api_temp.txt
              ESCAPED_API_CONTENT=$(cat api_temp.txt | jq -Rs .)
              
              # Create payload with properly escaped content
              echo '{
                "data": {
                  "title": "express-api NPM Dependency Report",
                  "body": '"$ESCAPED_API_CONTENT"'
                }
              }' > api_payload.json
              
              # Debug the final payload
              echo "Final payload structure:"
              cat api_payload.json | jq '.'
              
              API_RESPONSE=$(curl -X POST \
                -H "Content-Type: application/json" \
                -H "X-Automation-Webhook-Token: ${{ secrets.JIRA_API_TOKEN }}" \
                --data @api_payload.json \
                -w "\n%{http_code}" \
                -s \
                "${{ secrets.JIRA_WEBHOOK_URL }}")
              
              API_HTTP_CODE=$(echo "$API_RESPONSE" | tail -n1)
              API_CONTENT_RESPONSE=$(echo "$API_RESPONSE" | sed '$d')
              
              echo "API Request Status Code: $API_HTTP_CODE"
              
              if [ "$API_HTTP_CODE" -ge 200 ] && [ "$API_HTTP_CODE" -lt 300 ]; then
                echo "✅ API Jira ticket created successfully"
              else
                echo "❌ Failed to create API Jira ticket. Status code: $API_HTTP_CODE"
                echo "Response: $API_CONTENT_RESPONSE"
              fi
            else
              echo "No API content found to send to Jira"
            fi
            
            # Create JIRA ticket for APP issues
            if [ -n "$APP_CONTENT" ] && [ "$APP_CONTENT" != "null" ]; then
              echo "Sending APP dependency report to Jira..."
              
              # Debug: check the content
              echo "Content length: ${#APP_CONTENT}"
              echo "First few characters:"
              echo "$APP_CONTENT" | head -c 100
              
              # Write content to file and properly escape it for JSON
              echo "$APP_CONTENT" > app_temp.txt
              ESCAPED_APP_CONTENT=$(cat app_temp.txt | jq -Rs .)
              
              # Create payload with properly escaped content
              echo '{
                "data": {
                  "title": "react-app NPM Dependency Report",
                  "body": '"$ESCAPED_APP_CONTENT"'
                }
              }' > app_payload.json
              
              # Debug the final payload
              echo "Final payload structure:"
              cat app_payload.json | jq '.'
              
              APP_RESPONSE=$(curl -X POST \
                -H "Content-Type: application/json" \
                -H "X-Automation-Webhook-Token: ${{ secrets.JIRA_API_TOKEN }}" \
                --data @app_payload.json \
                -w "\n%{http_code}" \
                -s \
                "${{ secrets.JIRA_WEBHOOK_URL }}")
              
              APP_HTTP_CODE=$(echo "$APP_RESPONSE" | tail -n1)
              APP_CONTENT_RESPONSE=$(echo "$APP_RESPONSE" | sed '$d')
              
              echo "APP Request Status Code: $APP_HTTP_CODE"
              
              if [ "$APP_HTTP_CODE" -ge 200 ] && [ "$APP_HTTP_CODE" -lt 300 ]; then
                echo "✅ APP Jira ticket created successfully"
              else
                echo "❌ Failed to create APP Jira ticket. Status code: $APP_HTTP_CODE"
                echo "Response: $APP_CONTENT_RESPONSE" 
              fi
            else
              echo "No APP content found to send to Jira"
            fi        run: |
            # Extract the content from the commentContents JSON
            COMMENT_JSON='${{ env.commentContents }}'
            
            # Extract API and APP content using jq
            API_CONTENT=$(echo $COMMENT_JSON | jq -r '.["express-api"]')
            APP_CONTENT=$(echo $COMMENT_JSON | jq -r '.["react-app"]')
            
            # Create JIRA ticket for API issues
            if [ -n "$API_CONTENT" ] && [ "$API_CONTENT" != "null" ]; then
              echo "Sending API dependency report to Jira..."
              
              # Debug: check the content
              echo "Content length: ${#API_CONTENT}"
              echo "First few characters:"
              echo "$API_CONTENT" | head -c 100
              
              # Prepare the payload by wrapping the content in the expected structure
              jq -n --arg title "express-api NPM Dependency Report" \
                    --arg body "$API_CONTENT" \
                    '{
                      "data": {
                        "title": $title,
                        "body": $body
                      }
                    }' > api_payload.json
              
              # Debug the final payload
              echo "Final payload structure:"
              cat api_payload.json | jq '.'
              
              API_RESPONSE=$(curl -X POST \
                -H "Content-Type: application/json" \
                -H "X-Automation-Webhook-Token: ${{ secrets.JIRA_API_TOKEN }}" \
                --data @api_payload.json \
                -w "\n%{http_code}" \
                -s \
                "${{ secrets.JIRA_WEBHOOK_URL }}")
              
              API_HTTP_CODE=$(echo "$API_RESPONSE" | tail -n1)
              API_CONTENT_RESPONSE=$(echo "$API_RESPONSE" | sed '$d')
              
              echo "API Request Status Code: $API_HTTP_CODE"
              
              if [ "$API_HTTP_CODE" -ge 200 ] && [ "$API_HTTP_CODE" -lt 300 ]; then
                echo "✅ API Jira ticket created successfully"
              else
                echo "❌ Failed to create API Jira ticket. Status code: $API_HTTP_CODE"
                echo "Response: $API_CONTENT_RESPONSE"
                exit 1
              fi
            else
              echo "No API content found to send to Jira"
            fi
            
            # Create JIRA ticket for APP issues
            if [ -n "$APP_CONTENT" ] && [ "$APP_CONTENT" != "null" ]; then
              echo "Sending APP dependency report to Jira..."
              
              # Debug: check the content
              echo "Content length: ${#APP_CONTENT}"
              echo "First few characters:"
              echo "$APP_CONTENT" | head -c 100
              
              # Prepare the payload by wrapping the content in the expected structure
              jq -n --arg title "react-app NPM Dependency Report" \
                    --arg body "$APP_CONTENT" \
                    '{
                      "data": {
                        "title": $title,
                        "body": $body
                      }
                    }' > app_payload.json
              
              # Debug the final payload
              echo "Final payload structure:"
              cat app_payload.json | jq '.'
              
              APP_RESPONSE=$(curl -X POST \
                -H "Content-Type: application/json" \
                -H "X-Automation-Webhook-Token: ${{ secrets.JIRA_API_TOKEN }}" \
                --data @app_payload.json \
                -w "\n%{http_code}" \
                -s \
                "${{ secrets.JIRA_WEBHOOK_URL }}")
              
              APP_HTTP_CODE=$(echo "$APP_RESPONSE" | tail -n1)
              APP_CONTENT_RESPONSE=$(echo "$APP_RESPONSE" | sed '$d')
              
              echo "APP Request Status Code: $APP_HTTP_CODE"
              
              if [ "$APP_HTTP_CODE" -ge 200 ] && [ "$APP_HTTP_CODE" -lt 300 ]; then
                echo "✅ APP Jira ticket created successfully"
              else
                echo "❌ Failed to create APP Jira ticket. Status code: $APP_HTTP_CODE"
                echo "Response: $APP_CONTENT_RESPONSE" 
                exit 1
              fi
            else
              echo "No APP content found to send to Jira"
            fi
